name: è‡ªåŠ¨æ„å»ºéƒ¨ç½²

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ${{ secrets.PROJECT_PATH || '/var/www/learn' }}

          # æš‚å­˜ç°æœ‰ä»£ç ï¼ˆå¦‚æœæœ‰æœªæäº¤çš„æ›´æ”¹ï¼‰
          git stash

          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull origin main


          chmod +x ./reset-data.sh
          ./reset-data.sh --admin-only

          # è®¾ç½®Node.jsç¯å¢ƒ
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          # æ¸…ç†pm2è¿›ç¨‹
          pm2 delete all || true

          # 1. æ„å»ºå‰ç«¯é¡¹ç›®
          echo "ğŸ“¦ å¼€å§‹æ„å»ºå‰ç«¯é¡¹ç›®..."
          
          # æ„å»ºlearn-adminé¡¹ç›®
          cd ./learn-admin
          npm install --legacy-peer-deps
          npm run build
          echo "âœ… learn-adminæ„å»ºå®Œæˆ"
          
          # æ„å»ºlearn-appé¡¹ç›®
          cd ${{ secrets.PROJECT_PATH || '/var/www/learn' }}
          cd ./learn-app
          npm install --legacy-peer-deps
          npm run build
          echo "âœ… learn-appæ„å»ºå®Œæˆ"
          
          # å®‰è£…åç«¯ä¾èµ–
          cd ${{ secrets.PROJECT_PATH || '/var/www/learn' }}
          cd ./learn-server
          npm install --legacy-peer-deps
          echo "âœ… learn-serverä¾èµ–å®‰è£…å®Œæˆ"

          # 2. ä½¿ç”¨pm2å¯åŠ¨æœåŠ¡
          echo "ğŸš€ ä½¿ç”¨pm2å¯åŠ¨æœåŠ¡..."
          
          # å¯åŠ¨learn-adminé¢„è§ˆæœåŠ¡ (ç«¯å£5173)
          cd ${{ secrets.PROJECT_PATH || '/var/www/learn' }}/learn-admin
          pm2 start npm --name "learn-admin" -- run preview -- --port 5173 --host 0.0.0.0
          
          # å¯åŠ¨learn-serveråç«¯æœåŠ¡ (ç«¯å£3000)
          cd ${{ secrets.PROJECT_PATH || '/var/www/learn' }}/learn-server  
          pm2 start npm --name "learn-server" -- run start
          
          # ä¿å­˜pm2é…ç½®
          pm2 save
          pm2 startup


          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "æœåŠ¡åœ°å€ï¼š"
          echo "- åç«¯API: http://$(hostname -I | awk '{print $1}'):3000"
          echo "- ç®¡ç†ç«¯: http://$(hostname -I | awk '{print $1}'):5173"
          echo "- Appç«¯: http://$(hostname -I | awk '{print $1}'):8082"

  notify:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      if: always()
      run: |
        if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "æ‰€æœ‰æœåŠ¡å·²åœ¨ä»¥ä¸‹ç«¯å£å¯åŠ¨ï¼š"
          echo "- åç«¯æœåŠ¡ (learn-server): 3000"
          echo "- ç®¡ç†ç«¯ (learn-admin): 5173" 
          echo "- Appç«¯ (learn-app): 8082"
          echo ""
          echo "ä½¿ç”¨ pm2 status æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
          echo "ä½¿ç”¨ pm2 logs æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
        fi 